name: Supabase Schema Migration

on:
  workflow_dispatch:
    inputs:
      migration_name:
        description: 'Name of the migration (e.g., add_users_table)'
        required: true
        type: string
      scope:
        description: 'Migration scope: full_schema or specific_table'
        required: true
        type: choice
        options:
          - full_schema
          - specific_table
      table_name:
        description: 'Table name (required if scope=specific_table)'
        required: false
        type: string

env:
  TESTING_VPS_IP: 72.61.226.144
  PRODUCTION_VPS_IP: 72.61.246.138
  TESTING_DB_CONTAINER: supabase-db-lcs8k80cgc4wocgg4gs8owgo
  PRODUCTION_DB_CONTAINER: supabase-db-xgcogw0wkcswsgg4o404ow4w

jobs:
  generate-migration:
    name: Generate Migration from Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.TESTING_VPS_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ env.PRODUCTION_VPS_IP }} >> ~/.ssh/known_hosts

      - name: Generate Migration SQL
        run: |
          echo "ðŸ”„ Generating migration from Testing VPS..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          MIGRATION_FILE="${TIMESTAMP}_${{ inputs.migration_name }}.sql"
          
          if [ "${{ inputs.scope }}" = "full_schema" ]; then
            echo "ðŸ“¦ Generating full public schema migration..."
            ssh -i ~/.ssh/deploy_key root@${{ env.TESTING_VPS_IP }} \
              "docker exec ${{ env.TESTING_DB_CONTAINER }} \
               pg_dump -U postgres --schema-only --no-owner --no-privileges \
               -n public postgres > /root/migrations/${MIGRATION_FILE}"
          else
            echo "ðŸ“¦ Generating migration for table: ${{ inputs.table_name }}..."
            ssh -i ~/.ssh/deploy_key root@${{ env.TESTING_VPS_IP }} \
              "docker exec ${{ env.TESTING_DB_CONTAINER }} \
               pg_dump -U postgres --schema-only --no-owner --no-privileges \
               -n public -t public.${{ inputs.table_name }} postgres > /root/migrations/${MIGRATION_FILE}"
          fi
          
          echo "MIGRATION_FILE=${MIGRATION_FILE}" >> $GITHUB_ENV

      - name: Retrieve & Preview Migration
        run: |
          echo "ðŸ“¥ Retrieving migration file..."
          ssh -i ~/.ssh/deploy_key root@${{ env.TESTING_VPS_IP }} \
            "cat /root/migrations/${{ env.MIGRATION_FILE }}" > migration.sql
          
          echo "ðŸ“„ Migration Preview (first 30 lines):"
          head -n 30 migration.sql
          
          echo ""
          echo "ðŸ“Š Migration Statistics:"
          echo "Total lines: $(wc -l < migration.sql)"
          echo "File size: $(du -h migration.sql | cut -f1)"

      - name: Validate Migration Safety
        run: |
          echo "ðŸ” Checking for dangerous operations..."
          
          DANGEROUS_OPS=$(grep -iE "DROP TABLE|TRUNCATE|DELETE FROM" migration.sql || true)
          
          if [ -n "$DANGEROUS_OPS" ]; then
            echo "âš ï¸ WARNING: Dangerous operations detected:"
            echo "$DANGEROUS_OPS"
            echo ""
            echo "âŒ Migration blocked for safety. Review required."
            exit 1
          else
            echo "âœ… No dangerous operations found. Migration is safe."
          fi

      - name: Upload Migration Artifact
        uses: actions/upload-artifact@v4
        with:
          name: migration-sql
          path: migration.sql
          retention-days: 30

  apply-to-production:
    name: Apply Migration to Production
    runs-on: ubuntu-latest
    needs: generate-migration
    environment:
      name: production
      
    steps:
      - name: Download Migration Artifact
        uses: actions/download-artifact@v4
        with:
          name: migration-sql

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.TESTING_VPS_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ env.PRODUCTION_VPS_IP }} >> ~/.ssh/known_hosts

      - name: Backup Production Schema
        run: |
          echo "ðŸ’¾ Creating Production backup..."
          BACKUP_FILE="prod_backup_$(date +%Y%m%d_%H%M%S).sql"
          
          ssh -i ~/.ssh/deploy_key root@${{ env.PRODUCTION_VPS_IP }} \
            "docker exec ${{ env.PRODUCTION_DB_CONTAINER }} \
             pg_dump -U postgres --schema-only -n public postgres > /root/backups/${BACKUP_FILE}"
          
          echo "âœ… Backup created: ${BACKUP_FILE}"

      - name: Count Production Rows (Before)
        id: before_count
        run: |
          echo "ðŸ“Š Counting rows before migration..."
          
          if [ "${{ inputs.scope }}" = "specific_table" ] && [ -n "${{ inputs.table_name }}" ]; then
            BEFORE_COUNT=$(ssh -i ~/.ssh/deploy_key root@${{ env.PRODUCTION_VPS_IP }} \
              "docker exec ${{ env.PRODUCTION_DB_CONTAINER }} \
               psql -U postgres -d postgres -t -c 'SELECT COUNT(*) FROM public.${{ inputs.table_name }};' 2>/dev/null || echo '0'")
            
            echo "before_count=${BEFORE_COUNT}" >> $GITHUB_OUTPUT
            echo "Table: ${{ inputs.table_name }}, Rows: ${BEFORE_COUNT}"
          else
            echo "before_count=N/A" >> $GITHUB_OUTPUT
            echo "Full schema migration - row count check skipped"
          fi

      - name: Apply Migration to Production
        run: |
          echo "ðŸš€ Applying migration to Production..."
          
          cat migration.sql | ssh -i ~/.ssh/deploy_key root@${{ env.PRODUCTION_VPS_IP }} \
            "docker exec -i ${{ env.PRODUCTION_DB_CONTAINER }} \
             psql -U postgres -d postgres"
          
          echo "âœ… Migration applied successfully"

      - name: Count Production Rows (After)
        id: after_count
        run: |
          echo "ðŸ“Š Counting rows after migration..."
          
          if [ "${{ inputs.scope }}" = "specific_table" ] && [ -n "${{ inputs.table_name }}" ]; then
            AFTER_COUNT=$(ssh -i ~/.ssh/deploy_key root@${{ env.PRODUCTION_VPS_IP }} \
              "docker exec ${{ env.PRODUCTION_DB_CONTAINER }} \
               psql -U postgres -d postgres -t -c 'SELECT COUNT(*) FROM public.${{ inputs.table_name }};'")
            
            echo "after_count=${AFTER_COUNT}" >> $GITHUB_OUTPUT
            echo "Table: ${{ inputs.table_name }}, Rows: ${AFTER_COUNT}"
          else
            echo "after_count=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Verify Data Integrity
        if: inputs.scope == 'specific_table'
        run: |
          BEFORE="${{ steps.before_count.outputs.before_count }}"
          AFTER="${{ steps.after_count.outputs.after_count }}"
          
          if [ "$BEFORE" != "N/A" ] && [ "$AFTER" != "N/A" ]; then
            if [ "$BEFORE" -eq "$AFTER" ]; then
              echo "âœ… Data integrity verified: $BEFORE rows â†’ $AFTER rows (MATCH)"
            else
              echo "âš ï¸ WARNING: Row count changed: $BEFORE rows â†’ $AFTER rows"
              echo "This may be expected if the migration modifies data."
            fi
          fi

      - name: Verify Schema Deployment
        run: |
          echo "ðŸ” Verifying schema in Production..."
          
          if [ "${{ inputs.scope }}" = "specific_table" ]; then
            ssh -i ~/.ssh/deploy_key root@${{ env.PRODUCTION_VPS_IP }} \
              "docker exec ${{ env.PRODUCTION_DB_CONTAINER }} \
               psql -U postgres -d postgres -c '\\dt public.${{ inputs.table_name }}'"
          else
            ssh -i ~/.ssh/deploy_key root@${{ env.PRODUCTION_VPS_IP }} \
              "docker exec ${{ env.PRODUCTION_DB_CONTAINER }} \
               psql -U postgres -d postgres -c '\\dt public.*'"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸ“‹ Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Migration:** ${{ inputs.migration_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scope:** ${{ inputs.scope }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.scope }}" = "specific_table" ]; then
            echo "**Table:** ${{ inputs.table_name }}" >> $GITHUB_STEP_SUMMARY
            echo "**Rows Before:** ${{ steps.before_count.outputs.before_count }}" >> $GITHUB_STEP_SUMMARY
            echo "**Rows After:** ${{ steps.after_count.outputs.after_count }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Successfully deployed to Production" >> $GITHUB_STEP_SUMMARY
